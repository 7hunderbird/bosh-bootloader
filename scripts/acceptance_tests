#!/bin/bash -eu

TERRAFORM_BINARY_PATH=${TERRAFORM_BINARY_PATH:-}
ROOT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." && pwd )"

source $ROOT_DIR/scripts/create_mod

function cleanup_terraform() {
  rm -rf ${ROOT_DIR}/terraform/binary_dist/terraform
}

function main() {
  cleanup_terraform
  trap "cleanup_terraform" INT TERM EXIT

  local parallelFlag
  if [[ "${BBL_IAAS}" == "aws" ]]; then
    parallelFlag=""
  else
    parallelFlag="-p"
  fi

  cp  ${TERRAFORM_BINARY_PATH} ${ROOT_DIR}/terraform/binary_dist

  pushd "${ROOT_DIR}/acceptance-tests" > /dev/null
    create_mod
    ginkgo -r -v ${parallelFlag} -race -failFast -randomizeAllSpecs -randomizeSuites -skipPackage no-iaas
    cleanup_mod
  popd > /dev/null
}

main "${@:-""}"
