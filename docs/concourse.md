# Generic Steps for Concourse Deployment

This document will walk through deploying a concourse clustered
install using `bbl` and `bosh`.

## Prerequisites

- `bbl`
- [bosh v2](https://bosh.io/docs/cli-v2.html)
- [concourse/concourse-bosh-deployment](https://github.com/concourse/concourse-bosh-deployment)

## Steps

### Create an environment and upload a stemcell.

  Stemcell Url for each IAAS
  
  ```bash
  # GCP
  export STEMCELL_URL="https://bosh.io/d/stemcells/bosh-google-kvm-ubuntu-xenial-go_agent"
  # AWS
  export STEMCELL_URL="https://bosh.io/d/stemcells/bosh-aws-xen-hvm-ubuntu-xenial-go_agent"
  # Azure
  export STEMCELL_URL="https://bosh.io/d/stemcells/bosh-azure-hyperv-ubuntu-xenial-go_agent"
  ```

  ```bash
  mkdir my-concourse-bbl-state
  cd my-concourse-bbl-state
  
  bbl up --lb-type concourse

  eval "$(bbl print-env)"

  bosh upload-stemcell "${STEMCELL_URL}"
  
  export IAAS="$(cat bbl-state.json | jq -r .iaas)"
  if [ "${IAAS}" = "aws" ]; then
    export EXTERNAL_HOST="$(bbl outputs | grep concourse_lb_url | cut -d ' ' -f2)"
  else # Azure and GCP
    export EXTERNAL_HOST="$(bbl outputs | grep concourse_lb_ip | cut -d ' ' -f2)"
  fi
  ```

### Deploy concourse


#### On Azure and GCP
  ```bash
pushd $GOPATH/src/github.com/concourse/concourse-bosh-deployment/cluster
  
      export USERNAME="username"
      export PASSWORD="super-secure-password"
      cat > vars.yml <<EOL
external_host: "${EXTERNAL_HOST}"
external_url: "https://${EXTERNAL_HOST}"
local_user:
    username: "${USERNAME}"
    password: "${PASSWORD}"
network_name: 'private'
web_network_name: 'private'
web_vm_type: 'default'
web_network_vm_extension: 'lb'
db_vm_type: 'default'
db_persistent_disk_type: '1GB'
worker_vm_type: 'default'
deployment_name: 'concourse'
EOL

    bosh deploy -d concourse concourse.yml \
      -l ../versions.yml \
      -l vars.yml \
      -o operations/basic-auth.yml \
      -o operations/privileged-http.yml \
      -o operations/privileged-https.yml \
      -o operations/tls.yml \
      -o operations/tls-vars.yml \
      -o operations/web-network-extension.yml
   
 popd
  ```
  
#### On AWS
```bash
pushd $GOPATH/src/github.com/concourse/concourse-bosh-deployment/cluster
  
      export USERNAME="username"
      export PASSWORD="super-secure-password"
      cat > vars.yml <<EOL
external_host: "${EXTERNAL_HOST}"
external_url: "https://${EXTERNAL_HOST}"
local_user:
    username: "${USERNAME}"
    password: "${PASSWORD}"
network_name: 'private'
web_network_name: 'private'
web_vm_type: 'default'
web_network_vm_extension: 'lb'
db_vm_type: 'default'
db_persistent_disk_type: '1GB'
worker_vm_type: 'default'
deployment_name: 'concourse'
EOL

    cat > aws-tls-vars.yml <<EOL
- type: replace
  path: /variables/-
  value:
    name: atc_ca
    type: certificate
    options:
      is_ca: true
      common_name: atcCA

- type: replace
  path: /variables/-
  value:
    name: atc_tls
    type: certificate
    options:
      ca: atc_ca
      alternative_names: [((external_host))]
      organization: atcOrg
EOL

    bosh deploy -d concourse concourse.yml \
      -l ../versions.yml \
      -l vars.yml \
      -o operations/basic-auth.yml \
      -o operations/privileged-http.yml \
      -o operations/privileged-https.yml \
      -o operations/tls.yml \
      -o aws-tls-vars.yml \
      -o operations/web-network-extension.yml
   
popd
```

  
** Note: The cert and key pair generated by the `tls-vars.yml` operations file are not real. If you need to be able to talk to your concourse over a trusted tls connection, you will need to pass in a cert/key pair that your workstation will recognize. 

Example:
  ```bash
  cat >tls-vars-vars-file.yml <<EOL
atc_tls:
    certificate: |
      <some-multi-line-cert>
    ca: |
      <some-multi-line-ca>
    private_key: |
      <some-multi-line-key>
EOL

bosh deploy -d concourse concourse.yml 
    ...
    -l tls-vars-vars-file.yml \
    ...
  ```

## Verify Successful Deployment
Point your browser to `https://${EXTERNAL_HOST}`.
Log in to the concourse with `${USERNAME}` and `${PASSWORD}`
